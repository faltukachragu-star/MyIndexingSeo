<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificrawl - Real-Time Indexing & GSC Tool</title>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        body { background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 1rem; }
        .page-container { max-width: 800px; margin: 2rem auto; }
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        header svg { color: #2563eb; width: 40px; height: 40px; }
        header h1 { font-size: 2rem; font-weight: 800; color: #111827; margin: 0 0 0 1rem; }
        .panel { background-color: #ffffff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; margin-top: 2rem; }
        .panel h2 { text-align: center; font-size: 1.5rem; margin-top:0; color: #1f2937;}
        label { display: block; margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        input[type="file"], input[type="text"], textarea, select { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; background-color: #fff; }
        textarea { resize: vertical; min-height: 150px; }
        button, a.button { background-color: #2563eb; color: white; padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; transition: background-color 0.2s; margin-top: 1.5rem; display: inline-block; text-align: center; text-decoration: none; box-sizing: border-box; }
        button:hover, a.button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .result { padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left-width: 5px; border-left-style: solid; font-family: 'Menlo', 'Consolas', monospace; font-size: 0.9em;}
        .result-success { background-color: #f0fdf4; border-color: #22c55e; color: #15803d; }
        .result-error { background-color: #fef2f2; border-color: #ef4444; color: #b91c1c; }
        .result strong { display: block; word-wrap: break-word; }
        .result p { margin: 5px 0 0; }
        .auth-panel { text-align: center; }
        .user-status { background-color: #eef2ff; color: #4338ca; padding: 1rem; border-radius: 8px; text-align: center; }
        .user-status p { margin: 0; }
        .user-status a { color: #4338ca; font-weight: 600; margin-left: 1rem; }
        .tool-container, .gsc-tools { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; font-size: 0.9rem;}
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        td { color: #4b5563; word-break: break-all;}
        dl { margin-top: 1rem; }
        dt { font-weight: 600; color: #374151; }
        dd { margin-left: 0; margin-bottom: 0.75rem; color: #4b5563; }
        footer { text-align: center; margin-top: 2rem; color: #9ca3af; font-size: 0.9rem; }
        footer a { color: #6b7280; margin: 0 0.5rem; }
    </style>
</head>
<body>

<div class="page-container">
    <header>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
        <h1>Notificrawl</h1>
    </header>

    <div id="auth-container">
        <!-- JS will populate this. If it stays empty, JS failed. -->
    </div>

    <div class="tool-container" id="tool-container">
        <div class="panel">
            <h2>1. Select Your Website</h2>
            <div id="site-selector-container">
                <p style="text-align:center;">Checking login status...</p>
            </div>
        </div>

        <div class="gsc-tools" id="gsc-tools">
            <div class="panel">
                <h2>Search Console Performance</h2>
                <button type="submit" id="gsc-perf-button">Get Performance Data (Last 7 Days)</button>
                <div id="gsc-results-container"></div>
            </div>

            <div class="panel">
                <h2>URL Inspection Tool</h2>
                <form id="inspect-form">
                    <label for="inspection_url">URL to Inspect</label>
                    <input type="text" id="inspection_url" placeholder="Enter a full URL from the selected site" required>
                    <button type="submit" id="inspect-submit-button">Inspect URL</button>
                </form>
                <div id="inspect-results-container"></div>
            </div>
        </div>

        <div class="panel">
            <h2>Google Indexing API Notifier</h2>
            <form id="indexing-form">
                <label for="url_file">Submit URLs from File (.txt or .xml)</label>
                <input type="file" id="url_file" accept=".txt,.xml">
                <div style="text-align: center; margin: 1rem 0; color: #9ca3af;">OR</div>
                <textarea id="urls_textarea" placeholder="Paste one URL per line here..."></textarea>
                <button type="submit" id="indexing-submit-button">Start Indexing Request</button>
            </form>
            <div id="indexing-results-panel" style="display: none;"></div>
        </div>
    </div>
    
    <footer>
        <p>A high-performance indexing and GSC tool.</p>
        <p><a href="/privacy">Privacy Policy</a> &bull; <a href="/terms">Terms of Service</a></p>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Top-level error boundary to prevent blank screen ---
    try {
        // --- DOM Element References ---
        const authContainer = document.getElementById('auth-container');
        const toolContainer = document.getElementById('tool-container');
        const siteSelectorContainer = document.getElementById('site-selector-container');
        const gscTools = document.getElementById('gsc-tools');
        let selectedSiteUrl = null;

        // --- Helper Function for Robust Error Handling ---
        const handleApiError = async (response) => {
            let message = `HTTP Error: ${response.status} ${response.statusText}`;
            try {
                const errorJson = await response.json();
                // FastAPI uses 'detail', Google's direct errors might use 'message'
                message = errorJson.detail || errorJson.error?.message || JSON.stringify(errorJson);
            } catch (e) {
                // The response was not JSON, do nothing and stick with the HTTP error
            }
            throw new Error(message);
        };

        // --- Main Application Logic ---
        const initializeApp = async () => {
            const response = await fetch('/status');
            if (!response.ok) await handleApiError(response);
            const data = await response.json();

            if (data.logged_in) {
                authContainer.innerHTML = `<div class="user-status"><p>Signed in as <strong>${data.user.email}</strong> <a href="/logout">[Logout]</a></p></div>`;
                toolContainer.style.display = 'block';
                await fetchSites();
            } else {
                authContainer.innerHTML = `<div class="panel auth-panel"><h2>Sign In to Continue</h2><p style="color: #4b5563;">Connect your Google Account to use the Indexing & Search Console APIs.</p><a href="/login" class="button"><svg style="width: 20px; height: 20px; margin-right: 12px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.012,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>Sign In with Google</a></div>`;
            }
        };

        const fetchSites = async () => {
            siteSelectorContainer.innerHTML = `<p style="text-align:center;">Loading your sites from Google Search Console...</p>`;
            const response = await fetch('/gsc-sites');
            if (!response.ok) await handleApiError(response);
            const data = await response.json();

            if (data.sites && data.sites.length > 0) {
                const options = data.sites.map(site => `<option value="${site.siteUrl}">${site.siteUrl}</option>`).join('');
                siteSelectorContainer.innerHTML = `<select id="site-selector"><option value="">-- Select a property --</option>${options}</select>`;
                document.getElementById('site-selector').addEventListener('change', (e) => {
                    selectedSiteUrl = e.target.value;
                    gscTools.style.display = selectedSiteUrl ? 'block' : 'none';
                });
            } else {
                siteSelectorContainer.innerHTML = '<p style="text-align:center;">No sites found in your Google Search Console account.</p>';
            }
        };

        // --- Event Listeners Setup ---
        const setupEventListeners = () => {
            // GSC Performance
            document.getElementById('gsc-perf-button').addEventListener('click', async () => {
                if (!selectedSiteUrl) return;
                const button = document.getElementById('gsc-perf-button');
                const resultsContainer = document.getElementById('gsc-results-container');
                button.disabled = true;
                button.textContent = 'Fetching Data...';
                resultsContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
                try {
                    const response = await fetch(`/gsc-data?site_url=${encodeURIComponent(selectedSiteUrl)}`);
                    if (!response.ok) await handleApiError(response);
                    const result = await response.json();
                    if (result.data && result.data.length > 0) {
                        let tableHTML = '<table><thead><tr><th>Page</th><th>Clicks</th><th>Impressions</th><th>CTR</th><th>Position</th></tr></thead><tbody>';
                        result.data.forEach(row => { tableHTML += `<tr><td>${row.page}</td><td>${row.clicks}</td><td>${row.impressions}</td><td>${row.ctr}</td><td>${row.position}</td></tr>`; });
                        resultsContainer.innerHTML = tableHTML + '</tbody></table>';
                    } else {
                        resultsContainer.innerHTML = '<p style="text-align:center;">No performance data found for this site in the last 7 days.</p>';
                    }
                } catch (error) {
                    resultsContainer.innerHTML = `<div class="result result-error"><p><strong>Error:</strong> ${error.message}</p></div>`;
                } finally {
                    button.disabled = false;
                    button.textContent = 'Get Performance Data (Last 7 Days)';
                }
            });

            // URL Inspection
            document.getElementById('inspect-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedSiteUrl) return;
                const button = document.getElementById('inspect-submit-button');
                const resultsContainer = document.getElementById('inspect-results-container');
                const inspectionUrl = document.getElementById('inspection_url').value;
                button.disabled = true;
                button.textContent = 'Inspecting...';
                resultsContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
                try {
                    const response = await fetch(`/inspect-url?site_url=${encodeURIComponent(selectedSiteUrl)}&inspection_url=${encodeURIComponent(inspectionUrl)}`);
                    if (!response.ok) await handleApiError(response);
                    const result = await response.json();
                    const { verdict, coverageState, indexingState, lastCrawlTime, pageFetchState, robotsTxtState } = result.status;
                    let html = `<dl><dt>Overall Verdict:</dt><dd>${verdict || 'N/A'}</dd><dt>Coverage:</dt><dd>${coverageState || 'N/A'}</dd><dt>Indexing State:</dt><dd>${indexingState || 'N/A'}</dd><dt>Last Crawl Time:</dt><dd>${lastCrawlTime ? new Date(lastCrawlTime).toLocaleString() : 'N/A'}</dd><dt>Page Fetch State:</dt><dd>${pageFetchState || 'N/A'}</dd><dt>robots.txt State:</dt><dd>${robotsTxtState || 'N/A'}</dd></dl>`;
                    resultsContainer.innerHTML = html;
                } catch (error) {
                    resultsContainer.innerHTML = `<div class="result result-error"><p><strong>Error:</strong> ${error.message}</p></div>`;
                } finally {
                    button.disabled = false;
                    button.textContent = 'Inspect URL';
                }
            });

            // Indexing API
            document.getElementById('indexing-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const button = document.getElementById('indexing-submit-button');
                const resultsPanel = document.getElementById('indexing-results-panel');
                const urlsFile = document.getElementById('url_file').files[0];
                const urlsText = document.getElementById('urls_textarea').value;
                button.disabled = true;
                button.textContent = 'Processing...';
                resultsPanel.style.display = 'block';
                resultsPanel.innerHTML = '<h3>Live Indexing Results</h3><div id="results-container-inner"></div>';
                const resultsContainer = document.getElementById('results-container-inner');
                try {
                    const payload = {};
                    if (urlsFile) payload.urls_file = { filename: urlsFile.name, content: await urlsFile.text() };
                    else if (urlsText) payload.urls_text = urlsText;
                    else throw new Error("No URLs provided for indexing.");
                    const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);
                    ws.onopen = () => ws.send(JSON.stringify(payload));
                    ws.onmessage = (msg) => {
                        const result = JSON.parse(msg.data);
                        if (result.type === 'result') {
                            const div = document.createElement('div');
                            div.className = `result result-${result.status}`;
                            div.innerHTML = `<strong>${result.url}</strong><p>${result.status === 'success' ? '✅ SUCCESS' : `❌ FAILED: ${result.message}`}</p>`;
                            resultsContainer.appendChild(div);
                        } else if (result.type === 'done') {
                            resultsPanel.querySelector('h3').textContent = 'Indexing Processing Complete!';
                            ws.close();
                        } else if (result.type === 'critical_error') throw new Error(result.message);
                    };
                    ws.onerror = () => { throw new Error("WebSocket connection failed."); };
                    ws.onclose = () => { button.disabled = false; button.textContent = 'Start Indexing Request'; };
                } catch (error) {
                    resultsContainer.innerHTML = `<div class="result result-error"><p><strong>Error:</strong> ${error.message}</p></div>`;
                    button.disabled = false;
                    button.textContent = 'Start Indexing Request';
                }
            });
        };
        
        // --- Start the application ---
        initializeApp().catch(error => {
            console.error('Catastrophic failure during initialization:', error);
            authContainer.innerHTML = `<div class="panel result result-error"><p><strong>A critical error occurred:</strong> ${error.message}</p><p>Please try refreshing the page. If the problem persists, check the browser console for more details.</p></div>`;
        });
        
        setupEventListeners();

    } catch (e) {
        // This is the ultimate fallback. If something goes wrong even setting up the script.
        document.body.innerHTML = `<div style="padding: 2rem; text-align: center; font-family: sans-serif;"><h1>Application Error</h1><p>A fatal JavaScript error occurred. Please check the browser's developer console for details.</p><p>Error: ${e.message}</p></div>`;
    }
});
</script>

</body>
</html>
