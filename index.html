<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapid Indexer - Real-Time API Tool</title>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        body { background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 1rem; }
        .page-container { max-width: 800px; margin: 2rem auto; }
        
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        header svg { color: #2563eb; width: 40px; height: 40px; }
        header h1 { font-size: 2rem; font-weight: 800; color: #111827; margin: 0 0 0 1rem; }
        
        .panel { background-color: #ffffff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; }
        .results-panel { margin-top: 2rem; }
        .panel h2 { text-align: center; font-size: 1.5rem; margin-top:0; color: #1f2937;}

        label { display: block; margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        input[type="file"], textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 150px; }
        input[type="file"]:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        button { background-color: #2563eb; color: white; padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; transition: background-color 0.2s; margin-top: 1.5rem; }
        button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .result { padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left-width: 5px; border-left-style: solid; }
        .result-success { background-color: #f0fdf4; border-color: #22c55e; color: #15803d; }
        .result-error { background-color: #fef2f2; border-color: #ef4444; color: #b91c1c; }
        .result strong { font-family: 'Menlo', 'Consolas', monospace; display: block; word-wrap: break-word; }
        /* --- NEW & IMPROVED MODAL (POPUP) STYLES --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(4px); /* Adds a modern frosted glass effect */
}
.modal-box {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 420px; /* <--- REDUCED SIZE */
    width: 90%; /* For mobile */
    text-align: center;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    transform: translateY(-20px); /* Animate it in from the top */
    transition: transform 0.2s ease-out;
}
.modal-overlay:target, .modal-overlay[style*="flex"] {
    /* When the modal becomes visible, apply the transform */
    transform: translateY(0);
}
.modal-box h2 {
    margin-top: 0;
    font-size: 1.25rem; /* <--- SMALLER TITLE */
    color: #111827;
}
.modal-box p {
    color: #4b5563;
    font-size: 1rem; /* <--- SMALLER TEXT */
    line-height: 1.5;
    margin-bottom: 0;
}
.modal-box .button-group {
    margin-top: 2rem; /* <--- MORE SPACE ABOVE BUTTONS */
    display: flex;
    gap: 0.75rem; /* <--- TIGHTER BUTTONS */
}
.modal-box button, .modal-box a.button {
    flex: 1;
    text-decoration: none;
    display: inline-block;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    width: 100%; /* <--- THIS IS THE ONLY LINE YOU NEED TO ADD/CHANGE */
}
.modal-box button {
    background-color: #f3f4f6;
    color: #4b5563;
    border: 1px solid #e5e7eb;
}
.modal-box button:hover {
    background-color: #e5e7eb;
}
a.button.primary {
    background-color: #2563eb;
    color: white;
    border: 1px solid transparent;
}
a.button.primary:hover {
    background-color: #1d4ed8;
}

        footer { text-align: center; margin-top: 2rem; color: #9ca3af; }

        @media (max-width: 640px) {
            body { padding: 0.5rem; }
            .page-container { margin: 1rem auto; }
            .panel { padding: 1.5rem; }
            header h1 { font-size: 1.5rem; }
            .modal-box { width: 90%; }
        }
    </style>
</head>
<body>

<div class="page-container">
    <header>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
        <h1>Rapid Indexer</h1>
    </header>

    <div class="panel main-tool">
        <form id="indexing-form">
            <!-- *** THE TUTORIAL LINK HAS BEEN REMOVED FROM HERE FOR A CLEANER UI *** -->
            <label for="service_account_file">1. Upload API Key</label>
            <input type="file" id="service_account_file" accept=".json">
            
            <label for="url_file">2. Submit URLs (.txt or .xml)</label>
            <input type="file" id="url_file" accept=".txt,.xml">
            
            <div style="text-align: center; margin: 1rem 0; color: #9ca3af;">OR</div>
            <textarea id="urls_textarea" placeholder="Paste one URL per line here..."></textarea>
            
            <button type="submit" id="submit-button">Start Real-Time Indexing</button>
        </form>
    </div>
    
    <div class="panel results-panel" id="results-panel" style="display: none;">
        <!-- Results will be displayed here -->
    </div>

    <footer>
        <p>A high-performance indexing tool.</p>
    </footer>
</div>

<!-- ### THIS IS THE FULL, CORRECTED, AND RESTORED POPUP MODAL ### -->
<div class="modal-overlay" id="api-key-modal">
    <div class="modal-box">
        <h2>API Key Required</h2>
        <p>Please upload your Google Service Account JSON key to continue. If you don't have one, our tutorial will guide you through the quick setup.</p>
        <div class="button-group">
            <button onclick="document.getElementById('api-key-modal').style.display='none'">Got it</button>
            <a href="/tutorial" target="_blank" class="button primary">View Tutorial</a>
        </div>
    </div>
</div>

<script>
    // The JavaScript logic is already perfect and does not need any changes.
    // It will correctly show the modal defined above.
    const form = document.getElementById('indexing-form');
    const resultsPanel = document.getElementById('results-panel');
    const submitButton = document.getElementById('submit-button');
    const apiKeyModal = document.getElementById('api-key-modal');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const credsFile = document.getElementById('service_account_file').files[0];
        if (!credsFile) {
            apiKeyModal.style.display = 'flex'; // This line is what makes the popup appear
            return;
        }
        
        // ... The rest of your proven, working JavaScript logic goes here ...
        const urlsFile = document.getElementById('url_file').files[0];
        const urlsText = document.getElementById('urls_textarea').value;
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
        resultsPanel.style.display = 'block';
        resultsPanel.innerHTML = '<h2 id="results-title">Live Results</h2><div id="results-container"></div>'; // Reset results panel
        const resultsTitle = document.getElementById('results-title');
        const resultsContainer = document.getElementById('results-container');
        
        try {
            const payload = {};
            payload.credentials = JSON.parse(await (file => new Promise((res, rej) => { const r = new FileReader(); r.onload = e => res(e.target.result); r.onerror = e => rej(e); r.readAsText(file); }))(credsFile));
            if (urlsFile) {
                payload.urls_file = { filename: urlsFile.name, content: await (file => new Promise((res, rej) => { const r = new FileReader(); r.onload = e => res(e.target.result); r.onerror = e => rej(e); r.readAsText(file); }))(urlsFile) };
            } else if (urlsText) {
                payload.urls_text = urlsText;
            } else {
                throw new Error("No URLs provided.");
            }
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const ws = new WebSocket(`${wsProtocol}${window.location.host}/ws`);
            ws.onopen = () => { resultsTitle.textContent = `Live processing started...`; ws.send(JSON.stringify(payload)); };
            ws.onmessage = (event) => {
                const result = JSON.parse(event.data);
                if (result.type === 'result') {
                    const resultDiv = document.createElement('div');
                    resultDiv.classList.add('result');
                    if (result.status === 'success') {
                        resultDiv.classList.add('result-success');
                        resultDiv.innerHTML = `<strong>${result.url}</strong><p>✅ SUCCESS</p>`;
                    } else {
                        resultDiv.classList.add('result-error');
                        resultDiv.innerHTML = `<strong>${result.url}</strong><p>❌ FAILED: ${result.message}</p>`;
                    }
                    resultsContainer.appendChild(resultDiv);
                } else if (result.type === 'done') {
                    resultsTitle.textContent = `Processing Complete!`;
                    submitButton.disabled = false;
                    submitButton.textContent = 'Start Real-Time Indexing';
                    ws.close();
                } else if (result.type === 'critical_error') { throw new Error(`Server Error: ${result.message}`); }
            };
            ws.onerror = () => { throw new Error("WebSocket connection failed."); };
        } catch (error) {
            resultsTitle.textContent = 'Error';
            resultsPanel.innerHTML += `<div class="result result-error"><p><strong>Error:</strong> ${error.message}</p></div>`;
            submitButton.disabled = false;
            submitButton.textContent = 'Start Real-Time Indexing';
        }
    });
</script>

</body>
</html>
