<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificrawl - Real-Time Indexing API Tool</title>
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        body { background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 1rem; }
        .page-container { max-width: 800px; margin: 2rem auto; }
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        header svg { color: #2563eb; width: 40px; height: 40px; }
        header h1 { font-size: 2rem; font-weight: 800; color: #111827; margin: 0 0 0 1rem; }
        .panel { background-color: #ffffff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; }
        .results-panel { margin-top: 2rem; }
        .panel h2 { text-align: center; font-size: 1.5rem; margin-top:0; color: #1f2937;}
        label { display: block; margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        input[type="file"], textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 150px; }
        button, a.button { background-color: #2563eb; color: white; padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; transition: background-color 0.2s; margin-top: 1.5rem; display: inline-block; text-align: center; text-decoration: none; box-sizing: border-box; }
        button:hover, a.button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .result { padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left-width: 5px; border-left-style: solid; }
        .result-success { background-color: #f0fdf4; border-color: #22c55e; color: #15803d; }
        .result-error { background-color: #fef2f2; border-color: #ef4444; color: #b91c1c; }
        .result strong { font-family: 'Menlo', 'Consolas', monospace; display: block; word-wrap: break-word; }
        .result p { margin: 5px 0 0; }
        .auth-panel { text-align: center; margin-bottom: 2rem; }
        .user-status { background-color: #eef2ff; color: #4338ca; padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 2rem; }
        .user-status p { margin: 0; }
        .user-status a { color: #4338ca; font-weight: 600; margin-left: 1rem; }
        footer { text-align: center; margin-top: 2rem; color: #9ca3af; font-size: 0.9rem; }
        footer a { color: #6b7280; margin: 0 0.5rem; }
    </style>
</head>
<body>

<div class="page-container">
    <header>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
        <h1>Notificrawl</h1>
    </header>

    <div id="auth-container">
        <!-- This will be populated by JavaScript -->
    </div>

    <div class="panel main-tool" id="main-tool" style="display: none;">
        <form id="indexing-form">
            <label for="url_file">Submit URLs (.txt or .xml)</label>
            <input type="file" id="url_file" accept=".txt,.xml">
            
            <div style="text-align: center; margin: 1rem 0; color: #9ca3af;">OR</div>
            <textarea id="urls_textarea" placeholder="Paste one URL per line here..."></textarea>
            
            <button type="submit" id="submit-button">Start Indexing Request</button>
        </form>
    </div>
    
    <div class="panel results-panel" id="results-panel" style="display: none;">
        <!-- Results will be displayed here -->
    </div>

    <footer>
        <p>A high-performance indexing notification tool.</p>
        <p>
            <a href="/privacy">Privacy Policy</a> &bull; <a href="/terms">Terms of Service</a>
        </p>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const authContainer = document.getElementById('auth-container');
        const mainTool = document.getElementById('main-tool');
        const form = document.getElementById('indexing-form');
        const resultsPanel = document.getElementById('results-panel');
        const submitButton = document.getElementById('submit-button');

        try {
            const response = await fetch('/status');
            const data = await response.json();

            if (data.logged_in) {
                authContainer.innerHTML = `
                    <div class="user-status">
                        <p>Signed in as <strong>${data.user.email}</strong> <a href="/logout">[Logout]</a></p>
                    </div>
                `;
                mainTool.style.display = 'block';
            } else {
                authContainer.innerHTML = `
                    <div class="auth-panel">
                        <h2>Sign In to Continue</h2>
                        <p style="color: #4b5563;">Connect your Google Account to use the Indexing API.</p>
                        <a href="/login" class="button">
                            <svg style="width: 20px; height: 20px; margin-right: 12px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.012,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            Sign In with Google
                        </a>
                    </div>
                `;
                mainTool.style.display = 'none';
            }
        } catch (error) {
            console.error('Failed to get login status:', error);
            authContainer.innerHTML = '<p style="color: red; text-align: center;">Could not connect to the server.</p>';
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const urlsFile = document.getElementById('url_file').files[0];
            const urlsText = document.getElementById('urls_textarea').value;
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            resultsPanel.style.display = 'block';
            resultsPanel.innerHTML = '<h2 id="results-title">Live Results</h2><div id="results-container"></div>'; 
            const resultsTitle = document.getElementById('results-title');
            const resultsContainer = document.getElementById('results-container');
            
            try {
                const payload = {};
                if (urlsFile) {
                    payload.urls_file = { filename: urlsFile.name, content: await urlsFile.text() };
                } else if (urlsText) {
                    payload.urls_text = urlsText;
                } else {
                    throw new Error("No URLs provided.");
                }
                
                const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const ws = new WebSocket(`${wsProtocol}${window.location.host}/ws`);
                
                ws.onopen = () => { ws.send(JSON.stringify(payload)); };
                
                ws.onmessage = (event) => {
                    const result = JSON.parse(event.data);
                    if (result.type === 'result') {
                        const resultDiv = document.createElement('div');
                        resultDiv.classList.add('result');
                        if (result.status === 'success') {
                            resultDiv.classList.add('result-success');
                            resultDiv.innerHTML = `<strong>${result.url}</strong><p>✅ SUCCESS</p>`;
                        } else {
                            resultDiv.classList.add('result-error');
                            resultDiv.innerHTML = `<strong>${result.url}</strong><p>❌ FAILED: ${result.message}</p>`;
                        }
                        resultsContainer.appendChild(resultDiv);
                    } else if (result.type === 'done') {
                        resultsTitle.textContent = `Processing Complete!`;
                        submitButton.disabled = false;
                        submitButton.textContent = 'Start Indexing Request';
                        ws.close();
                    } else if (result.type === 'critical_error') { 
                        throw new Error(`Server Error: ${result.message}`); 
                    }
                };
                ws.onerror = (err) => { throw new Error("WebSocket connection failed."); };
                
            } catch (error) {
                resultsTitle.textContent = 'Error';
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('result', 'result-error');
                errorDiv.innerHTML = `<p><strong>Error:</strong> ${error.message}`;
                resultsContainer.appendChild(errorDiv);
                submitButton.disabled = false;
                submitButton.textContent = 'Start Indexing Request';
            }
        });
    });
</script>

</body>
</html>
